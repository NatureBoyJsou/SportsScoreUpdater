// front end

<script>
  const API = '/api/penguins';

  function safeDate(d) {
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  async function render() {
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');
    const latestContainer = document.getElementById('latestGameContainer');
    const scheduleDiv = document.getElementById('schedule');
    const fetchedEl = document.getElementById('fetchedAt');

    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const res = await fetch(API);
      const json = await res.json();

      loading.style.display = 'none';
      content.style.display = 'block';

      fetchedEl.textContent = 'Updated: ' + (json.fetchedAt || new Date().toISOString());

      // ---------------------------
      // LATEST GAME
      // ---------------------------
      const latest = json.latestGame;

      if (latest) {
        const dt = safeDate(latest.gameDate);

        const awayScore = latest.away?.score ?? latest.awayScore ?? '-';
        const homeScore = latest.home?.score ?? latest.homeScore ?? '-';

        latestContainer.innerHTML = `
          <div>
            <div class="team">
              <img class="teamLogo" src="${latest.away?.logo || latest.away?.strTeamBadge || ''}" alt="">
              <strong>${latest.away?.name || "?"}</strong>
            </div>

            <div class="score">${awayScore}</div>

            <div class="team" style="text-align:right;">
              <img class="teamLogo" src="${latest.home?.logo || latest.home?.strTeamBadge || ''}" alt="">
              <strong>${latest.home?.name || "?"}</strong>
            </div>

            <div class="score">${homeScore}</div>

            <div style="clear:both;"></div>

            <div class="status">
              Status: ${latest.status || "Unknown"} — ${dt ? dt.toLocaleString() : "Invalid Date"}
            </div>
          </div>
        `;
      } else {
        latestContainer.innerHTML = '<div>No recent game found.</div>';
      }

      // ---------------------------
      // UPCOMING GAMES
      // ---------------------------
      scheduleDiv.innerHTML = "";
      let upcoming = Array.isArray(json.upcomingGames) ? json.upcomingGames : [];

      console.log("Raw upcoming from backend:", upcoming);

      // Fix: normalize dates to avoid timezone mismatch
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      upcoming = upcoming.filter(g => {
        const dt = safeDate(g.gameDate);
        if (!dt) return false;
        const d2 = new Date(dt);
        d2.setHours(0, 0, 0, 0);
        return d2 >= today;
      });

      upcoming.sort((a, b) => new Date(a.gameDate) - new Date(b.gameDate));

      if (upcoming.length === 0) {
        scheduleDiv.innerHTML = '<div class="gameRow">No valid upcoming games found.</div>';
      } else {
        upcoming.forEach(g => {
          const dt = safeDate(g.gameDate);
          const row = document.createElement('div');
          row.className = 'gameRow';

          row.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
              <img class="teamLogoSmall" src="${g.away?.logo || g.away?.strTeamBadge || ''}">
              <strong>${g.away?.name || "?"}</strong>

              <span style="opacity:0.7; margin:0 8px;">@</span>

              <img class="teamLogoSmall" src="${g.home?.logo || g.home?.strTeamBadge || ''}">
              <strong>${g.home?.name || "?"}</strong>
            </div>

            <div>
              <small>${dt.toLocaleString()} — Status: ${g.status || "NS"}</small>
            </div>
          `;

          scheduleDiv.appendChild(row);
        });
      }

    } catch (err) {
      loading.style.display = 'none';
      content.style.display = 'block';

      latestContainer.innerHTML = '<div style="color:salmon">Failed to load data.</div>';
      scheduleDiv.innerHTML = `<div style="color:salmon">${err.message || String(err)}</div>`;
    }
  }

  render();
  setInterval(render, 45 * 1000);
</script>

